<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
	<title>俄罗斯方块</title>
	<style type="text/css">
		.e_div{border-top:1px solid #ccc;border-left:1px solid #ccc;width:240px; overflow:hidden;}
		.c_div{border-bottom:1px solid #ccc;border-right:1px solid #ccc;width:19px;height:19px;float:left;}
		.c_over{border-bottom:1px solid #ccc;border-right:1px solid #ccc;width:19px;height:19px;float:left;background:#C2222A;}
	</style>
	<script type="text/javascript" src="../js/base.js"></script>
</head>
<body>
	<div id="russia"></div>
	<script type="text/javascript">
		var Russia = bh.create({
			init:function(obj,figure,height,width){
				this.height =height;
				this.width = width;
				this.e_div = document.createElement("div");
				this.e_div.tabIndex= -1;
				this.e_div.className = "e_div"
				this.o_divs = []
				this.c_divs = [];
				this.now_div = null;
				this.next_div = null;
				this.figure = figure;
				this.setTimeoutId = null;
				for(i=0;i<this.height;i++){
					this.c_divs[i] = []
					for(j=0;j<this.width;j++){
						var _div = document.createElement("div");
						_div.className = "c_div";
						this.e_div.appendChild(_div);
						this.c_divs[i][j] = _div;
					}
				}
				obj.appendChild(this.e_div);
				bh.addEvent("keypress",this.e_div,bh.eventBridge(this,this.keyHandle))
			},
			load:function(){
				this.now_div = this.next_div || figure.createfigure();
				this.next_div = figure.createfigure();
				console.log(this.now_div);
				this.c_divs[this.now_div[1].x][this.now_div[1].y+=4].className = "c_over";
				this.c_divs[this.now_div[2].x][this.now_div[2].y+=4].className = "c_over";
				this.c_divs[this.now_div[3].x][this.now_div[3].y+=4].className = "c_over";
				this.c_divs[this.now_div[4].x][this.now_div[4].y+=4].className = "c_over";
			},
			moveDown:function(){
				var xmax = Math.max(this.now_div[1].x,this.now_div[2].x,this.now_div[3].x,this.now_div[4].x);
				var ymin = Math.min(this.now_div[1].y,this.now_div[2].y,this.now_div[3].y,this.now_div[4].y);
				var ymax = Math.max(this.now_div[1].y,this.now_div[2].y,this.now_div[3].y,this.now_div[4].y);
				var ratio = []
				var flage = true;
				for(i=1;i<5;i++){
					if(this.now_div[i].x == xmax){
						if(this.c_divs[xmax+1][this.now_div[i].y].className != "c_div"){
							flage = false;
						}
					}
				}
				if(this.now_div[1].x<this.height-1&&this.now_div[2].x<this.height-1&&this.now_div[3].x<this.height-1&&this.now_div[4].x<this.height-1
				&&flage){
					this.c_divs[this.now_div[1].x][this.now_div[1].y].className = "c_div";
					this.c_divs[this.now_div[2].x][this.now_div[2].y].className = "c_div";
					this.c_divs[this.now_div[3].x][this.now_div[3].y].className = "c_div";
					this.c_divs[this.now_div[4].x][this.now_div[4].y].className = "c_div";
					this.now_div[1].x += 1;
					this.now_div[2].x += 1;
					this.now_div[3].x += 1;
					this.now_div[4].x += 1;
					this.c_divs[this.now_div[1].x][this.now_div[1].y].className = "c_over";
					this.c_divs[this.now_div[2].x][this.now_div[2].y].className = "c_over";
					this.c_divs[this.now_div[3].x][this.now_div[3].y].className = "c_over";
					this.c_divs[this.now_div[4].x][this.now_div[4].y].className = "c_over";
				}else{
					this.load();
				}
				
			},
			moveLeft:function(){
				var xmin = Math.min(this.now_div[1].x,this.now_div[2].x,this.now_div[3].x,this.now_div[4].x);
				var xmax = Math.max(this.now_div[1].x,this.now_div[2].x,this.now_div[3].x,this.now_div[4].x);
				var ymin = Math.min(this.now_div[1].y,this.now_div[2].y,this.now_div[3].y,this.now_div[4].y);
				if(this.now_div[1].y>0&&this.now_div[2].y>0&&this.now_div[3].y>0&&this.now_div[4].y>0
				&&this.c_divs[xmin][ymin-1].className == "c_div"
				&&this.c_divs[xmin+1][ymin-1].className == "c_div"
				&&this.c_divs[xmax][ymin-1].className == "c_div"
				&&this.c_divs[xmax-1][ymin-1].className == "c_div"){
					this.c_divs[this.now_div[1].x][this.now_div[1].y].className = "c_div";
					this.c_divs[this.now_div[2].x][this.now_div[2].y].className = "c_div";
					this.c_divs[this.now_div[3].x][this.now_div[3].y].className = "c_div";
					this.c_divs[this.now_div[4].x][this.now_div[4].y].className = "c_div";
					this.c_divs[this.now_div[1].x][this.now_div[1].y-=1].className = "c_over";
					this.c_divs[this.now_div[2].x][this.now_div[2].y-=1].className = "c_over";
					this.c_divs[this.now_div[3].x][this.now_div[3].y-=1].className = "c_over";
					this.c_divs[this.now_div[4].x][this.now_div[4].y-=1].className = "c_over";
				}
			},
			moveRight:function(){
				var xmin = Math.min(this.now_div[1].x,this.now_div[2].x,this.now_div[3].x,this.now_div[4].x);
				var xmax = Math.max(this.now_div[1].x,this.now_div[2].x,this.now_div[3].x,this.now_div[4].x);
				var ymax = Math.max(this.now_div[1].y,this.now_div[2].y,this.now_div[3].y,this.now_div[4].y);
				if(this.now_div[1].y<this.width-1&&this.now_div[2].y<this.width-1&&this.now_div[3].y<this.width-1&&this.now_div[4].y<this.width-1
				&&this.c_divs[xmin][ymax+1].className == "c_div"
				&&this.c_divs[xmin+1][ymax+1].className == "c_div"
				&&this.c_divs[xmax][ymax+1].className == "c_div"
				&&this.c_divs[xmax-1][ymax+1].className == "c_div"){
					this.c_divs[this.now_div[1].x][this.now_div[1].y].className = "c_div";
					this.c_divs[this.now_div[2].x][this.now_div[2].y].className = "c_div";
					this.c_divs[this.now_div[3].x][this.now_div[3].y].className = "c_div";
					this.c_divs[this.now_div[4].x][this.now_div[4].y].className = "c_div";
					this.c_divs[this.now_div[1].x][this.now_div[1].y+=1].className = "c_over";
					this.c_divs[this.now_div[2].x][this.now_div[2].y+=1].className = "c_over";
					this.c_divs[this.now_div[3].x][this.now_div[3].y+=1].className = "c_over";
					this.c_divs[this.now_div[4].x][this.now_div[4].y+=1].className = "c_over";
				}
			},
			keyHandle:function(event){
				var key = event.keyCode;
				switch(key){
					case 37:this.moveLeft();break;
					case 38:alert(this);break;
					case 39:this.moveRight();break;
					case 40:console.log("加速");break;
					default :break;
				}
			}
		})
		var FigureManage = bh.create({
			init:function(){
				var rects = [];
				var figure = [[],[],[],[],[],[],[]]
			},
			createfigure:function (){
				rects = [[1,{x:1,y:1},{x:1,y:0},{x:0,y:1},{x:1,y:2}],[2,{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]];
				var i = Math.floor(Math.random()*2); 
				return rects[i];
			}
		})
		var figure = new FigureManage;
		var russia = new Russia(bh("russia"),figure,18,12);
		russia.load();
		var test = function(){	
			russia.moveDown();
			setTimeout(test,300)
		}
		test();
	</script>
</body>
</html>